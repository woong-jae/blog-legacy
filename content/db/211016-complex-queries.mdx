---
title: "Complex Queries"
date: "2021-10-16"
emoji: "ðŸ˜µâ€ðŸ’«"
category: "db"
---
## ë” ë³µìž¡í•œ ê²€ìƒ‰ ì¿¼ë¦¬
### Three valued logic
SQLì€ ì–´ë–¤ í‘œí˜„ì— ëŒ€í•œ ê²°ê³¼ë¡œ ì„¸ ê°€ì§€ ê°’, `TRUE`, `FALSE`, `UNKNOWN`(=`NULL`), ì„ ê°€ì§ˆ ìˆ˜ ìžˆë‹¤.
> `NULL`=`NULL`ì€ í‰ê°€ë  ìˆ˜ ì—†ë‹¤. ëŒ€ì‹  `IS` ì—°ì‚°ìžë¡œ `NULL`ì¸ì§€ ì•„ë‹Œì§€ í™•ì¸í•  ìˆ˜ ìžˆë‹¤. Not `NULL`ì€ `IS NOT`ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.

### Nested queries(ì¤‘ì²© ì§ˆì˜)
`SELECT`-`FROM`-`WHERE` ì ˆì„ ê°€ì§„ subquery(inner query)ë¥¼ ë‹¤ë¥¸ ì¿¼ë¦¬ì˜ `WHERE` ì ˆ(outer query)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤.
```sql
-- ì„±ì´ 'Smith'ì¸ ì§ì›ì´ ê´€ë¦¬í•˜ëŠ” ë¶€ì„œì—ì„œ ì§„í–‰í•˜ëŠ” í”„ë¡œì íŠ¸ Pnumber ê°€ì ¸ì˜¤ê¸°
SELECT DISTINCT Pnumber
FROM PROJECT
WHERE Pnumber IN (
    SELECT Pnumber
    FROM PROJECT, DEPARTMENT, EMPLOYEE
    WHERE Dnum = Dnumber AND Mgr_ssn = Ssn AND Lname = 'Smith'
);
```

#### Set/Multiset ë¹„êµ ì—°ì‚°ìž `IN`
ê°’ $v$ê°€ ì§‘í•© $V$ ì•ˆì— ìžˆìœ¼ë©´ `TRUE`ë¥¼ ê²°ê³¼ë¡œ ê°€ì§„ë‹¤.`IN` ë§ê³  ë‹¤ë¥¸ ë¹„êµ ì—°ì‚°ìžë„ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.
```sql
-- Department 5ì— ì¼í•˜ëŠ” ì§ì› ì „ì²´ë³´ë‹¤ ê¸‰ì—¬ê°€ í° ì§ì›ì˜ ì´ë¦„ì„ ê°€ì ¸ì˜¤ê¸°
SELECT Lname, Fname
FROM EMPLOYEE
WHERE Salary > ALL (
    SELECT Salary
    FROM EMPLOYEE
    WHERE Dno = 5
);
```

#### (NOT)EXISTS
ìƒí˜¸ ì—°ê´€ëœ ì¤‘ì²© ì§ˆì˜ì˜ ê²°ê³¼ê°€ ì¡´ìž¬í•˜ëŠ”ì§€ ì•„ë‹Œì§€(true or false) íŒë³„í•œë‹¤.
```sql
-- ì§ì› ì¤‘ ë¶€ì–‘ê°€ì¡±ì´ ìžˆëŠ” ì§ì›ì˜ ì´ë¦„ì„ ê°€ì ¸ì˜¤ê¸°
SELECT Fname, Lname
FROM EMPLOYEE
WHERE EXISTS (
    SELECT *
    FROM DEPENDENT
    WHERE Ssn = Essn
);
```
> `NOT EXISTS`ëŠ” "for all"ì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤(2ì¤‘ ë¶€ì •).

**ê°’ë“¤ì˜ ëª…ì‹œì ì¸ ì§‘í•©**ë„ ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤.
```sql
-- Pnumber 1 ,2, 3ì—ì„œ ì¼í•˜ëŠ” ëª¨ë“  ì§ì›ì˜ Essn ê°€ì ¸ì˜¤ê¸°
SELECT DISTINCT Essn
FROM WORKS_ON
WHERE Pno IN (1, 2 3);
```
### Joined tables
`FROM` ì ˆì—ì„œ join ì—°ì‚°ì„ í•  ìˆ˜ ìžˆë‹¤.
```sql
SELECT Fname, Lname, Address
FROM (EMPLOYEE JOIN DEPARTMENT ON Dno = Dnumber)
WHERE Dname = 'Research';
```
ì‚¬ìš©í•  ìˆ˜ ìžˆëŠ” `JOIN`ì˜ íƒ€ìž…:
- **NATURAL JOIN**: ë™ì¼í•œ ì´ë¦„ì„ ê°€ì§„ attributeì— ëŒ€í•´ joinì„ í•œë‹¤.

- **INNER JOIN**: default typeì´ë‹¤. ë§¤ì¹­í•˜ëŠ” íŠœí”Œì´ ë‹¤ë¥¸ relationì— ì¡´ìž¬í•˜ë©´ ê·¸ íŠœí”Œì„ ê²°ê³¼ì— í¬í•¨í•œë‹¤.

- **LEFT(RIGHT) OUTER JOIN**: ì™¼ìª½(ì˜¤ë¥¸ìª½) í…Œì´ë¸”ì˜ ëª¨ë“  íŠœí”Œì´ ê²°ê³¼ì— ë‚˜ì˜¨ë‹¤. ì¦‰, ì˜¤ë¥¸ìª½(ì™¼ìª½) íŠœí”Œê³¼ ë§¤ì¹­ë˜ëŠ” ê°’ì´ ì—†ëŠ” íŠœí”Œë„ ê²°ê³¼ì— ë‚˜ì˜¨ë‹¤.

- **FULL OUTER JOIN**: LEFT + RIGHT OUTER JOIN

### Aggregate functions(ì§‘ê³„ ì—°ì‚°)
ì–´ë–¤ ê·¸ë£¹ì— ì†í•˜ëŠ” íŠœí”Œë“¤ì˜ **ì •ë³´ë¥¼ ìš”ì•½í•´ì„œ í•˜ë‚˜ì˜ íŠœí”Œë¡œ** ë³´ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.

ì—°ì‚°ìž: `COUNT`, `SUM`, `AVG`, `MAX`, `MIN`

```sql
SELECT SUM(Salary), MAX(Salary), MIN(Salary), AVG(Salary)
FROM EMPLOYEE;
```

> `COUNT`ì—ì„œ **NULL ê°’ì€ ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠëŠ”ë‹¤**. í•˜ì§€ë§Œ **íŠœí”Œì„ ì„¼ë‹¤ë©´, ì–´ë–¤ íŠœí”Œì˜ attributeê°€ NULL ê°’ì„ ê°€ì ¸ë„ ì¹´ìš´íŠ¸** ëœë‹¤.

ì§‘ê³„ ì—°ì‚°ì€ `SELECT` ì ˆì´ë‚˜ `HAVING` ì ˆì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤. `HAVING`ì€ ê·¸ë£¹ì„ ì„ íƒí•˜ëŠ” ì»¨ë””ì…˜ì„ ìž‘ì„±í•  ìˆ˜ ìžˆëŠ” ì ˆì´ë‹¤.

### Grouping
`GROUP BY` ì ˆì„ ì‚¬ìš©í•´ì„œ relationì„ íŠœë“¤ë“¤ì˜ ë¶€ë¶„ì§‘í•©ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ìžˆë‹¤. 

Grouping attributeë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°™ì€ ê°’ì„ ê°€ì§„ tupleë¼ë¦¬ ë¬¶ëŠ”ë‹¤. Grouping attributeëŠ” `GROUP BY`ì ˆì— ëª…ì‹œí•˜ê³  **`SELECT`ì ˆì— ë¬´ì¡°ê±´ ë‚˜íƒ€ë‚˜ì•¼ í•œë‹¤**.
```sql
-- ë¶€ì„œë³„ ì§ì›ì˜ ìˆ˜ì™€ í‰ê·  ê¸‰ì—¬ë¥¼ ê°€ì ¸ì˜¤ê¸°
SELECT Dno, COUNT(*), AVG(Salary)
FROM EMPLOYEE
GROUP BY Dno;
```

### in-line view
`WITH`ì ˆì„ ì‚¬ìš©í•´ì„œ íŠ¹ì • ì¿¼ë¦¬ì—ì„œ ì‚¬ìš©ê°€ëŠ¥í•œ ê°€ìƒì´ í…Œì´ë¸”ì„ ì •ì˜í•œë‹¤.
```sql
-- 2ëª… ì´ìƒì´ ì¼í•˜ëŠ” ë¶€ì„œ ì¤‘ ê¸‰ì—¬ê°€ 40000 ì´ìƒì¸ ì§ì›ì˜ ìˆ˜ë¥¼ ê°€ì ¸ì˜¤ê¸°
WITH SOMEDEPTS AS (
    SELECT Dno
    FROM EMPLOYEE
    GROUP BY Dno
    HAVING COUNT (*) >= 2
)
SELECT e.Dno, COUNT(*)
FROM EMPLOYEE e, SOMEDEPTS b
WHERE Salary > 40000 AND e.Dno = b.Dno
GROUP BY e.Dno;
```

### CASE
ê°’ì´ íŠ¹ì • conditionì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìžˆì„ ë•Œ ì‚¬ìš©í•œë‹¤. SQL ì¿¼ë¦¬ ì¤‘ ê°’ì„ ê¸°ëŒ€í•˜ëŠ” ì–´ëŠ ë¶€ë¶„ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤.
```sql
UPDATE EMPLOYEE
SET Salary = CASE   WHEN Dno = 5 THEN Salary + 2000
                    WHEN Dno = 4 THEN Salary + 1500
                    WHEN Dno = 1 THEN Salary + 3000
```

### Recursive query
ê°™ì€ íƒ€ìž…ì˜ relationì—ì„œ íŠœí”Œ ê°„ì˜ ê´€ê³„(ê³„ì¸µêµ¬ì¡° ë“±)ë¥¼ íŒŒì•…í•  ë•Œ ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤.
```sql
-- ê³„ì¸µêµ¬ì¡° íƒìƒ‰
SELECT Super_ssn
FROM EMPLOYEE
START WITH Ssn = '123456789'
CONNECT BY PRIOR Super_ssn = Ssn;
```

## Views in SQL
SQLì—ì„œ viewëŠ” ë‹¤ë¥¸ í…Œì´ë¸”ë¡œë¶€í„° íŒŒìƒëœ í…Œì´ë¸”ì´ë‹¤. **ì‹¤ì œ ë¬¼ë¦¬ì ìœ¼ë¡œ ì ìž¬ë˜ì§€ ì•Šì€ ê°€ìƒ í…Œì´ë¸”**ì´ë‹¤. ViewëŠ” ì‹¤ì œë¡œ ì°¸ì¡°í•˜ê²Œ ë˜ëŠ” ìˆœê°„ ì‹¤ì œí™”/êµ¬ì²´í™”ëœë‹¤.

ViewëŠ” ìžì£¼ ì°¸ì¡°ë˜ëŠ” í…Œì´ë¸”ì„ ëª…ì‹œí•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ ìƒê°í•  ìˆ˜ ìžˆë‹¤. ìžì£¼ ì‚¬ìš©ë˜ëŠ” joined tableì˜ ìºì‰¬ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤.

`CREATE VIEW`ë¥¼ í†µí•´ viewì˜ ì´ë¦„ê³¼ attribute, ì •ì˜ë¥¼ ëª…ì‹œí•œë‹¤.
```sql
CREATE VIEW WORKS_ON1 AS
SELECT Fname, Lname, Pname, Hours
FROM EMPLOYEE, PROJECT, WORKS_ON
WHERE Ssn = Essn AND Pno = Pnumber;
```
### Viewì˜ ìž¥ì 
- **ì¿¼ë¦¬ë¥¼ ë‹¨ìˆœí™”** í•  ìˆ˜ ìžˆë‹¤.

- **ë³´ì•ˆ ë° ê¶Œí•œ** ë¶€ì—¬ ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•œë‹¤.

- ê°’ë¹„ì‹¼ **join costë¥¼ ì•„ë‚„ ìˆ˜ ìžˆë‹¤**.

### View êµ¬í˜„ì˜ ì ‘ê·¼
#### Query modification  
í•„ìš”í•  ë•Œë§Œ ë§Œë“¤ì–´ë‚¸ë‹¤. Viewê°€ ì°¸ì¡°ë  ë•Œë§ˆë‹¤ ìƒˆë¡œ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ì‹ì´ë‹¤.

ì´ ë°©ì‹ì€ ë³µìž¡í•œ ì¿¼ë¦¬ë“¤ë¡œ ì´ë£¨ì–´ì§„ viewì˜ ê²½ìš° ì°¸ì¡°í•  ë•Œë§ˆë‹¤ ì—°ì‚°ì„ ìˆ˜í–‰í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— ë¹„íš¨ìœ¨ì ì´ë‹¤.

#### View materialization
Viewê°€ ì²˜ìŒ ì°¸ì¡°ë  ë•Œ ìž„ì‹œ í…Œì´ë¸”ì„ ë¬¼ë¦¬ì ìœ¼ë¡œ ë§Œë“ ë‹¤. ì´ í…Œì´ë¸”ì— ëŒ€í•´ ì¿¼ë¦¬ê°€ ê³„ì† ì´ë£¨ì–´ì§€ë©´ ë‚¨ì•„ìžˆë‹¤ê°€ ì¼ì •ê¸°ê°„ë™ì•ˆ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë©´ ì‚­ì œëœë‹¤.

ì´ ë°©ì‹ì—ì„œëŠ” í…Œì´ë¸”ì„ ìžë™ìœ¼ë¡œ updateí•˜ê¸° ìœ„í•œ íš¨ìœ¨ì ì¸ ë°©ë²•ì´ í•„ìš”í•˜ë‹¤.

- **Incremental** update: ë³€í™”ì— ì˜í–¥ë°›ì€ tuple DBMSê°€ íŒë³„í•´ì„œ ê°±ì‹ í•œë‹¤.

- **Immediate** update: Viewì˜ base tableì´ ë³€ê²½ë˜ë©´ ê°±ì‹ í•œë‹¤.

- **Lazy** update: Viewê°€ ì°¸ì¡°ë  ë•Œ ê°±ì‹ í•œë‹¤.

- **Periodic** update: ì¼ì • ì£¼ê¸°ë¡œ ê°±ì‹ í•œë‹¤.

ì¼ë°˜ì ì¸ ê²½ìš° view í…Œì´ë¸”ì„ `INSERT`/`DELETE`/`UPDATE`ë¡œ ì§ì ‘ ë³€ê²½í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤. 
ì™œëƒí•˜ë©´ viewì—ëŠ” ë§Žì€ tableì´ ì°¸ì—¬í•˜ê³  ìžˆê¸° ë–„ë¬¸ì— ëª…ë ¹ì–´ê°€ ì¤‘ì˜ì ì¸ ì˜ë¯¸ë¥¼ ê°€ì§ˆ ìˆ˜ë„ ìžˆê¸° ë•Œë¬¸ì´ë‹¤.

## Schema change statements in SQL
- `DROP`  
    ìŠ¤í‚¤ë§ˆ ìš”ì†Œ(tables, domains, constraints)ë“¤ì„ ì‚­ì œí•  ë•Œ ì‚¬ìš©í•œë‹¤.  
    Option: `CASCADE`, `RESTRICT`

- `ALTER TABLE`  
    attribute ì¶”ê°€/ì œê±°/ìž¬ì •ì˜, í…Œì´ë¸” ì œì•½ì¡°ê±´ ì¶”ê°€/ì‚­ì œ, default ê°’ ë³€ê²½ ë“±ì— ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤.

## Assertion and Triggers
CREATE ASSERTION: ì¼ë°˜ ì œì•½ì¡°ê±´ì„ ëª…ì‹œí•  ìˆ˜ ìžˆë‹¤. ì˜¤ë¼í´ì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠëŠ”ë‹¤.

### Trigger
íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ê³  conditionì´ ë§Œì¡±ë˜ì—ˆì„ ë•Œ ì·¨í•  í–‰ë™ì„ ëª…ì‹œí•  ìˆ˜ ìžˆë‹¤.

Events, Condition, Action(ECA)ë¡œ ì •ì˜ëœë‹¤.
```sql
CREATE OR REPLACE
TRIGGER SALARY_VIOLATION
BEFORE  INSERT OR UPDATE OF Salary ON EMPLOYEE
FOR EACH ROW
        WHEN (NEW.SALARY > 100000)
        BEGIN
          INFORM_SALARY_VIOLATION(:NEW.SALARY, :OLD.Salary); -- Stored procedure
        END;
/
```
