---
title: "Vanilla Javascriptë¡œ êµ¬í˜„í•˜ëŠ” SPA - ìƒíƒœê´€ë¦¬ ì‹œìŠ¤í…œ"
date: "2022-03-27 17:05"
emoji: "ğŸ’€"
category: "javascript"
---

## í•„ìš”ì„±

ì´ì „ì— ë§Œë“¤ì—ˆë˜ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ë‹¤ë³´ë©´ í•œê°€ì§€ ë¬¸ì œì ì´ ë°œìƒí•œë‹¤. ìì‹ ì»´í¬ë„ŒíŠ¸ë“¤ë¼ë¦¬ ìƒíƒœ ê³µìœ ê°€ í•„ìš”í•˜ë©´, ê·¸ ìƒíƒœê°€ ê³µí†µ ë¶€ëª¨ê¹Œì§€ ëŒì–´ì˜¬ë ¤ì ¸ì•¼ í•œë‹¤. ì´ ë¬¸ì œë¥¼ **props drilling** ë¬¸ì œë¼ê³  í•œë‹¤. Reactì—ì„œë„ ë˜‘ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

ë¬¸ì œì— ëŒ€í•œ í•´ê²°ë²• ì¤‘ í•˜ë‚˜ê°€ ì¤‘ì•™ ì§‘ì¤‘ì‹ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤. ìƒíƒœë¥¼ ì»´í¬ë„ŒíŠ¸ ì™¸ë¶€ì— ë‘ ìœ¼ë¡œì¨ props drilling í˜„ìƒì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•  ìˆ˜ ìˆë‹¤.

## ì˜µì €ë²„ íŒ¨í„´

Reactì˜ 'Redux'ë‚˜ Vueì˜ 'Vuex' ê°™ì€Â ì¤‘ì•™ ì§‘ì¤‘ì‹ ì €ì¥ì†ŒëŠ” [ì˜µì €ë²„ íŒ¨í„´](https://woong-jae.com/javascript/220322-observer-pattern)ì— ê¸°ë°˜ì„ ë‘”ë‹¤.

'Publisher-Subscriber' ëª¨ë¸ì´ë¼ê³ ë„ ë¶ˆë¦¬ëŠ” ì´ íŒ¨í„´ì€, ì–´ë–¤ ê°ì²´ì˜ ìƒíƒœê°€ ë³€í•˜ë©´ ì—°ê´€ëœ ê°ì²´ë“¤ì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ë””ìì¸ íŒ¨í„´ì´ë‹¤.

ì´ íŒ¨í„´ì˜ í•µì‹¬ì€ ìƒíƒœë¥¼ ê°€ì§„ ê°ì²´ì¸ 'Publisher'ì—, ì´ ê°ì²´ë¥¼ ê´€ì°°í•˜ëŠ” ì˜µì €ë²„ë“¤ì¸ 'Subscriber'ë“¤ì„ ë“±ë¡ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤. êµ¬ë…ìë“¤ì€ ë°œí–‰ê¸°ê´€ì´ ë°œìƒì‹œí‚¤ëŠ” ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ ì²˜ë¦¬í•œë‹¤.

<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8d/Observer.svg/1708px-Observer.svg.png" />

ìš°ë¦¬ì˜ ë¬¸ì œì—ì„œ publisherëŠ” ì €ì¥ì†Œ, subscriberëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ë  ê²ƒì´ë‹¤. ê·¸ë¦¬ê³  ë°œí–‰ê¸°ê´€ì´ ë°œìƒì‹œí‚¤ëŠ” ì´ë²¤íŠ¸ëŠ” ìƒíƒœê°€ ë³€ê²½ëì„ ë•Œì´ê³ , ì»´í¬ë„ŒíŠ¸ë“¤ì€ ë³€ê²½ëœ ìƒíƒœì— ë”°ë¼ ë¦¬ë Œë”ë§ì„ í•˜ë©´ ëœë‹¤.

## êµ¬í˜„

### Observable model

Publisher-Subscriber ëª¨ë¸ì„ ê°„ëµí™”í•œ observable ëª¨ë¸ì„ ì‚¬ìš©í•  ê²ƒì´ë‹¤. ê°œë…ì€ ë˜‘ê°™ë‹¤. Observeë¡œ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰í•  í–‰ë™ì„ ë“±ë¡í•˜ê³ , observableì€ ì´ë²¤íŠ¸ë¥¼ ì¼ìœ¼í‚¤ëŠ” ê°ì²´ê°€ ëœë‹¤.

```js
// observable.js
let requestingListener = null;

export const observe = (cb) => {
  requestingListener = cb;
  cb();
  requestingListener = null;
};

export const observable = (obj) => {
  const propsToListener = new Map();

  return new Proxy(obj, {
    get(target, prop) {
      // observeë¡œ í˜¸ì¶œí•œ í•¨ìˆ˜ì—ì„œ ì‚¬ìš©í•œ propë§ˆë‹¤ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•œë‹¤.
      if (!propsToListener.has(prop)) propsToListener.set(prop, new Set());
      if (requestingListener) propsToListener.get(prop).add(requestingListener);
      return target[prop];
    },
    set(target, prop, val) {
      if (target[prop] === val) return true;
      target[prop] = val;
      propsToListener.get(prop).forEach((cb) => cb());
      return true;
    },
  });
};
```

ì‹¤í–‰íë¦„

1. `observe`ë¥¼ í˜¸ì¶œí•œë‹¤.
2. `requestingListener`ê°€ `cb`(ì½œë°±)ì„ ì°¸ì¡°í•˜ê³ , ì½œë°±ì´ í•œ ë²ˆ ì‹¤í–‰ëœë‹¤.
3. ì½œë°± ì•ˆì—ì„œ `observable`ë¡œ ë§Œë“¤ì–´ì§„ ê°ì²´ì˜ í”„ë¡œí¼í‹°ê°€ ì°¸ì¡°ë˜ë©´, `Proxy`ì˜ `get` trapì„ í†µí•´ í”„ë¡œí¼í‹°ì— ëŒ€í•œ ë¦¬ìŠ¤ë„ˆë¡œ `requestingListener(= cb)`ì´ ë“±ë¡ëœë‹¤.
4. ì½œë°±ì˜ ì‹¤í–‰ì´ ëë‚˜ê³  `requestingListener`ë¥¼ `null`ë¡œ ë°”ê¿”ì¤€ë‹¤.
5. `observable`ë¡œ ë§Œë“¤ì–´ì§„ ê°ì²´ì˜ í”„ë¡œí¼í‹°ê°€ ë³€ê²½ë˜ë©´, `set` trapìœ¼ë¡œ ì´ë¥¼ ê°ì§€í•  ìˆ˜ ìˆë‹¤. ìƒˆë¡œìš´ ê°’ì´ ê¸°ì¡´ í”„ë¡œí¼í‹°ì˜ ê°’ê³¼ ë‹¤ë¥´ë‹¤ë©´, í”„ë¡œí¼í‹°ë¥¼ ìƒˆë¡œìš´ ê°’ìœ¼ë¡œ ë³€ê²½í•˜ê³  í•´ë‹¹ í”„ë¡œí¼í‹°ì— ë“±ë¡ëœ ëª¨ë“  ë¦¬ìŠ¤í„°ë¥¼ í˜¸ì¶œ(ì•Œë¦¼)í•œë‹¤.

ì´ê²ƒì„ ì €ì¥ì†Œì— ì ìš©í•˜ë©´ ëœë‹¤. ì €ì¥ì†Œì˜ ìƒíƒœê°€ ë³€ê²½ëì„ ë•Œ ì–´ë–»ê²Œ ì»´í¬ë„ŒíŠ¸ì—ê²Œ ì•Œë¦´ ìˆ˜ ìˆì„ê¹Œ?

ì €ì¥ì†Œì˜ stateë¥¼ `observable`ë¡œ ìƒì„±í•˜ê³ , ì»´í¬ë„ŒíŠ¸ì˜ ë Œë”ë§ ì‘ì—…ì„ `observe`ë¡œ ë“±ë¡í•˜ë©´ stateê°€ ë³€ê²½ëì„ ë•Œ ë¦¬ë Œë”ë§ì´ ë°œìƒí•  ê²ƒì´ë‹¤.

```js
export default class Component {
  constructor(target, props) {
    this.target = target;
    this.props = props;
    this.setup();
    observe(() => {
      this.render();
      this.mounted();
    });
  }
  // ...
}
```

### ì¤‘ì•™ ì§‘ì¤‘ì‹ ì €ì¥ì†Œ

ì €ì¥ì†ŒëŠ” `state`ì™€ `state`ë¥¼ ë³€ê²½í•˜ëŠ” í–‰ìœ„ë“¤ì¸ `actions`ë¥¼ ë°›ë„ë¡ êµ¬í˜„í•  ê²ƒì´ë‹¤. `actions`ë¥¼ ë”°ë¡œ ì£¼ëŠ” ì´ìœ ëŠ”, `state`ë¥¼ ì§ì ‘ ë³€ê²½í•  ìˆ˜ ì—†ë„ë¡ í•˜ê¸° ìœ„í•¨ì´ë‹¤. ì´ ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ë°ì´í„° ë³€í™”ê°€ í›¨ì”¬ ì˜ˆì¸¡í•˜ê¸° ì‰¬ì›Œì§„ë‹¤.

ì €ì¥ì†Œë¡œ `state` ì •ë³´ë¥¼ ì ‘ê·¼í•  ìˆ˜ ìˆê³ , `commit`ì„ í†µí•´ ì •ì˜í•œ í–‰ìœ„ë¥¼ ì‹¤í–‰í•´ ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.

```js
class Store {
  #state;
  #actions;
  state = {};
  constructor({ state, actions }) {
    this.#state = observable(state);
    this.#actions = actions;
    Object.keys(state).forEach((key) => {
      Object.defineProperty(this.state, key, { get: () => this.#state[key] });
    });
  }
  commit(action, payload) {
    this.#actions[action](this.#state, payload);
  }
}
```

## ì‚¬ìš©ì˜ˆì‹œ

'ì»´í¬ë„ŒíŠ¸ ë§Œë“¤ê¸°'ì—ì„œ ì‚¬ìš©í•œ ì˜ˆì‹œì™€ ë™ì¼í•˜ì§€ë§Œ, ì»´í¬ë„ŒíŠ¸ì˜ `state` ëŒ€ì‹  `Store`ë¥¼ ì‚¬ìš©í•œ ì˜ˆì‹œë‹¤.

```js
const store = new Store({
  state: {
    typed: "",
  },
  actions: {
    CHANGE_TYPED(state, payload) {
      state.typed = payload;
    },
  },
});

class InputMirror extends Component {
  template() {
    return `
			<div>
				<div class="input-container"></div>
				<div class="mirror-container"></div>
			</div>
		`;
  }
  mounted() {
    new Input(document.querySelector(".input-container"));
    new Mirror(document.querySelector(".mirror-container"));
  }
}

class Input extends Component {
  template() {
    return `
			<div>
				<input class="input" value="${store.state.typed}" />
			</div>
		`;
  }
  mounted() {
    document.querySelector(".input").addEventListener("change", (event) => {
      store.commit("CHANGE_TYPED", event.target.value);
    });
  }
}

class Mirror extends Component {
  template() {
    return `<p>Typed: ${store.state.typed}</p>`;
  }
}

const app = document.getElementById("app");
new InputMirror(app);
```

## ë§ˆì¹˜ë©°

ì§ì ‘ êµ¬í˜„í•´ë³´ë‹ˆ ì¤‘ì•™ ì§‘ì¤‘ì‹ ì €ì¥ì†Œì— ë” ì˜ ì´í•´í•˜ê²Œ ëœ ê²ƒ ê°™ë‹¤. ê·¸ë¦¬ê³  ì—­ì‹œ ë§Œë“¤ì–´ì§„ ê²ƒì„ ì‚¬ìš©í•˜ëŠ”ê²Œ í¸í•˜ê¸´ í•˜ë‹¤...ã…‹ã…‹ ë‚˜ë„ ì–¸ì  ê°„ ë‚˜ì˜ ì² í•™ì´ ë‹´ê¸´ ë·° í”„ë ˆì„ì›Œí¬ë¥¼ ë§Œë“¤ì–´ë³´ê³  ì‹¶ë‹¤.

## ì°¸ì¡°

- https://junilhwang.github.io/TIL/Javascript/Design/Vanilla-JS-Store/#_5-flux-pattern
- https://peter-cho.gitbook.io/book/5/5_2
- https://vuex.vuejs.org/
